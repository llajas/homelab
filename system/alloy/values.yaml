alloy:
  alloy:
    configMap:
      create: true
      content: |
        discovery.kubernetes "pods" {
          role = "pod"
          selectors {
            role = "pod"
            field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
          }
        }

        discovery.relabel "pods" {
          targets = discovery.kubernetes.pods.targets

          rule {
            source_labels = ["__meta_kubernetes_pod_phase"]
            regex         = "Pending|Succeeded|Failed|Completed"
            action        = "drop"
          }

          rule {
            source_labels = ["__meta_kubernetes_namespace"]
            target_label  = "namespace"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_name"]
            target_label  = "pod"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_container_name"]
            target_label  = "container"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_controller_name"]
            target_label  = "job"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_node_name"]
            target_label  = "node"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
            target_label  = "app"
          }

          rule {
            source_labels = ["__meta_kubernetes_pod_label_app"]
            target_label  = "app"
            regex         = "(.+)"
            replacement   = "$1"
          }
        }

        loki.source.kubernetes "pods" {
          targets    = discovery.relabel.pods.output
          forward_to = [loki.process.pods.receiver]
        }

        loki.process "pods" {
          forward_to = [loki.write.default.receiver]

          // Extract level from JSON logs (silently skips non-JSON)
          stage.json {
            expressions = {
              level = "level",
            }
          }

          // Apply extracted level as label if present
          stage.labels {
            values = {
              level = "",
            }
          }
        }

        loki.write "default" {
          endpoint {
            url = "http://loki-gateway.loki.svc.cluster.local/loki/api/v1/push"
          }
        }

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

  controller:
    type: daemonset
    tolerations:
      - effect: NoSchedule
        operator: Exists

  serviceMonitor:
    enabled: true
