kured:
  configuration:
    annotateNodes: true
    rebootSentinelCommand: sh -c "/usr/local/bin/rebooter.sh"
    useRebootSentinelHostPath: false
    period: 5m
    rebootDays: [mo, tu, we, th]
    startTime: 5:00
    endTime: 7:30
    timeZone: America/Chicago

  initContainers:
    - name: deploy-rebooter-script
      image: alpine:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          REBOOTER_SCRIPT_BASE64="IyEvYmluL2Jhc2gKCkxPR19GSUxFPSIvdmFyL2xvZy9yZWJvb3Rlcl9jaGVjay5sb2ciCgojIEZ1bmN0aW9uIHRvIGxvZyBtZXNzYWdlcwpsb2dfbWVzc2FnZSgpIHsKICAgICMgU2V0IHRoZSBUWiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byBBbWVyaWNhL0NoaWNhZ28KICAgIGVjaG8gIiQoVFo9J0FtZXJpY2EvQ2hpY2FnbycgZGF0ZSAnKyVZLSVtLSVkICVIOiVNOiVTICVaJyk6ICQxIiA+PiAiJExPR19GSUxFIgp9CgojIENoZWNrIGlmIC92YXIvcnVuL3JlYm9vdC1yZXF1aXJlZCBleGlzdHMKaWYgWyAtZiAiL3Zhci9ydW4vcmVib290LXJlcXVpcmVkIiBdOyB0aGVuCiAgICBsb2dfbWVzc2FnZSAiUmVib290IHJlcXVpcmVkIGR1ZSB0byAvdmFyL3J1bi9yZWJvb3QtcmVxdWlyZWQgZmlsZS4iCiAgICBleGl0IDAKZmkKCiMgQWx0ZXJuYXRpdmVseSwgdXNlIG5lZWRzLXJlc3RhcnRpbmcgdG8gY2hlY2sgaWYgYSByZWJvb3QgaXMgbmVlZGVkCm5lZWRzLXJlc3RhcnRpbmcgLS1yZWJvb3RoaW50ClJFQk9PVF9ORUVERUQ9JD8KaWYgWyAkUkVCT09UX05FRURFRCAtZXEgMSBdOyB0aGVuCiAgICBsb2dfbWVzc2FnZSAiUmVib290IHJlcXVpcmVkIGFjY29yZGluZyB0byBuZWVkcy1yZXN0YXJ0aW5nLiIKICAgIGV4aXQgMAplbHNlCiAgICBsb2dfbWVzc2FnZSAiTm8gcmVib290IG5lZWRlZCBhY2NvcmRpbmcgdG8gbmVlZHMtcmVzdGFydGluZy4iCiAgICBleGl0IDEKZmkKCiMgRGVmYXVsdCBleGl0LCBtZWFuaW5nIG5vIHJlYm9vdCByZXF1aXJlZApsb2dfbWVzc2FnZSAiTm8gcmVib290IHJlcXVpcmVkLiIKZXhpdCAxCg=="
          
          # Decode script to temporary file
          echo "$REBOOTER_SCRIPT_BASE64" | base64 -d > /tmp/rebooter.sh.new
          
          # Set update flag to true by default
          UPDATE_NEEDED=1
          
          if [ -f /host/usr/local/bin/rebooter.sh ]; then
            # Calculate md5sum of the new script
            NEW_SCRIPT_MD5=$(md5sum /tmp/rebooter.sh.new | cut -d' ' -f1)
            
            # Calculate md5sum of the existing script
            EXISTING_SCRIPT_MD5=$(md5sum /host/usr/local/bin/rebooter.sh | cut -d' ' -f1)
            
            if [ "$NEW_SCRIPT_MD5" = "$EXISTING_SCRIPT_MD5" ]; then
              echo "rebooter.sh script is up-to-date. No changes needed."
              UPDATE_NEEDED=0
            else
              echo "rebooter.sh script has changed. Updating..."
            fi
          else
            echo "Deploying rebooter script for the first time..."
          fi
          
          # Update the script if needed
          if [ $UPDATE_NEEDED -eq 1 ]; then
            cp /tmp/rebooter.sh.new /host/usr/local/bin/rebooter.sh
            chmod +x /host/usr/local/bin/rebooter.sh
            echo "rebooter.sh script has been installed/updated."
          fi
          
          # Clean up temporary file
          rm /tmp/rebooter.sh.new
      volumeMounts:
        - name: host-usr-local-bin
          mountPath: /host/usr/local/bin

  volumes:
    - name: host-usr-local-bin
      hostPath:
        path: /usr/local/bin
        type: DirectoryOrCreate
