app-template:
  controllers:
    main:
      initContainers:
        resolve-dns:
          image:
            repository: busybox
            tag: "1.36"
            pullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Resolving backend DNS names..."
              
              # Resolve lancache-dns
              LANCACHE_IP=$(nslookup lancache-dns.lancache.svc.cluster.local 2>/dev/null | grep -A1 'Name:' | grep Address | awk '{print $2}' | head -1)
              if [ -z "$LANCACHE_IP" ]; then
                echo "Warning: Could not resolve lancache-dns, using placeholder"
                LANCACHE_IP="127.0.0.1"
              fi
              echo "lancache-dns resolved to: $LANCACHE_IP"
              
              # Resolve unbound
              UNBOUND_IP=$(nslookup unbound.unbound.svc.cluster.local 2>/dev/null | grep -A1 'Name:' | grep Address | awk '{print $2}' | head -1)
              if [ -z "$UNBOUND_IP" ]; then
                echo "Error: Could not resolve unbound"
                exit 1
              fi
              echo "unbound resolved to: $UNBOUND_IP"
              
              # Generate dnsdist config with resolved IPs
              cat > /config-out/dnsdist.conf << EOF
              -- dnsdist configuration for Lancache DNS failover
              -- Generated at container startup with resolved IPs
              --
              -- Primary: Lancache DNS (resolved: $LANCACHE_IP)
              -- Fallback: Unbound (resolved: $UNBOUND_IP)

              -- Primary upstream - Lancache DNS
              newServer({
                  address="$LANCACHE_IP:53",
                  name="lancache-dns",
                  order=1,
                  checkInterval=1,
                  checkTimeout=1000,
                  maxCheckFailures=3,
                  rise=2,
                  checkName="a.root-servers.net.",
                  checkType="A"
              })

              -- Fallback upstream - Unbound
              newServer({
                  address="$UNBOUND_IP:53",
                  name="unbound-fallback",
                  order=2,
                  checkInterval=5,
                  checkTimeout=1000,
                  maxCheckFailures=3,
                  rise=2,
                  checkName="a.root-servers.net.",
                  checkType="A"
              })

              -- Use firstAvailable policy
              setServerPolicy(firstAvailable)

              -- Listen on all interfaces
              setLocal("0.0.0.0:53")

              -- Allow all queries
              setACL({"0.0.0.0/0", "::/0"})

              -- Return ServFail if ALL backends are down
              setServFailWhenNoServer(true)

              -- Enable verbose health check logging
              setVerboseHealthChecks(true)

              -- Enable console for health checks
              controlSocket("127.0.0.1:5199")

              -- Enable webserver for Prometheus metrics
              webserver("0.0.0.0:8083")
              setWebserverConfig({
                  acl="0.0.0.0/0, ::/0",
                  apiRequiresAuthentication=false,
                  statsRequireAuthentication=false
              })
              EOF
              
              echo "Config generated successfully"
              cat /config-out/dnsdist.conf
      containers:
        main:
          image:
            repository: powerdns/dnsdist-19
            tag: "1.9.11"
            pullPolicy: IfNotPresent
          args:
            - --config=/config-out/dnsdist.conf
            - --supervised
          ports:
            - name: dns-udp
              containerPort: 53
              protocol: UDP
            - name: dns-tcp
              containerPort: 53
              protocol: TCP
            - name: webserver
              containerPort: 8083
              protocol: TCP
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - "echo 'showServers()' | dnsdist -c 127.0.0.1:5199 | grep -qE '(UP|up)'"
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - "echo 'showServers()' | dnsdist -c 127.0.0.1:5199 | grep -qE '(UP|up)'"
                initialDelaySeconds: 5
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 2
            startup:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - "echo 'showServers()' | dnsdist -c 127.0.0.1:5199"
                initialDelaySeconds: 5
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 30
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              memory: 64Mi

  service:
    main:
      controller: main
      type: LoadBalancer
      loadBalancerIP: 10.137.0.230
      externalTrafficPolicy: Local
      annotations:
        metallb.universe.tf/ip-allocated-from-pool: default
      ports:
        dns-udp:
          port: 53
          targetPort: dns-udp
          protocol: UDP
        dns-tcp:
          port: 53
          targetPort: dns-tcp
          protocol: TCP
    webserver:
      controller: main
      type: ClusterIP
      ports:
        http:
          port: 8083
          targetPort: webserver
          protocol: TCP

  serviceMonitor:
    main:
      enabled: true
      serviceName: '{{ include "bjw-s.common.lib.chart.names.fullname" . }}-webserver'
      endpoints:
        - port: http
          scheme: http
          path: /metrics
          interval: 30s
          scrapeTimeout: 10s

  persistence:
    config-out:
      enabled: true
      type: emptyDir
      advancedMounts:
        main:
          resolve-dns:
            - path: /config-out
          main:
            - path: /config-out
              readOnly: true

  defaultPodOptions:
    nodeSelector:
      kubernetes.io/arch: amd64
